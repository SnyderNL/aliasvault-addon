name: CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install linters
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck yamllint jq

      - name: Shellcheck scripts
        run: |
          shellcheck aliasvault/ha-persist-init.sh aliasvault/ha-persist-finish.sh aliasvault/run.sh

      - name: Validate addon config JSON
        run: |
          jq . aliasvault/config.json >/dev/null

      - name: Enforce short HA changelog (max 3 versions)
        run: |
          COUNT=$(grep -c '^## ' aliasvault/CHANGELOG.md)
          echo "Found $COUNT changelog version sections"
          if [ "$COUNT" -gt 3 ]; then
            echo "CHANGELOG.md may contain at most 3 version sections for Home Assistant readability."
            echo "Move older entries to aliasvault/CHANGELOG_ARCHIVE.md"
            exit 1
          fi

      - name: Lint issue templates
        run: |
          yamllint .github/ISSUE_TEMPLATE/*.yml
