name: Auto bump add-on version on upstream image change

on:
  push:
    branches:
      - main
    paths:
      - aliasvault/Dockerfile
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-addon-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Detect upstream image tag change
        id: detect
        run: |
          BEFORE=$(git show HEAD~1:aliasvault/Dockerfile | sed -n 's/^ARG UPSTREAM_IMAGE=ghcr.io\/aliasvault\/aliasvault:\(.*\)$/\1/p' | head -n1)
          AFTER=$(sed -n 's/^ARG UPSTREAM_IMAGE=ghcr.io\/aliasvault\/aliasvault:\(.*\)$/\1/p' aliasvault/Dockerfile | head -n1)
          echo "before=$BEFORE" >> "$GITHUB_OUTPUT"
          echo "after=$AFTER" >> "$GITHUB_OUTPUT"
          if [ -n "$BEFORE" ] && [ -n "$AFTER" ] && [ "$BEFORE" != "$AFTER" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump add-on patch version + changelog
        if: steps.detect.outputs.changed == 'true'
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          config_path = Path('aliasvault/config.json')
          changelog_path = Path('aliasvault/CHANGELOG.md')

          config = json.loads(config_path.read_text(encoding='utf-8'))
          old_version = config['version']
          major, minor, patch = map(int, old_version.split('.'))

          # Version policy:
          # - normal upstream auto-bump => patch +1
          # - whenever patch reaches 9, next bump rolls to next minor at .0
          #   examples: 0.0.9 -> 0.1.0, 0.1.9 -> 0.2.0
          if patch >= 9:
              minor += 1
              patch = 0
          else:
              patch += 1

          new_version = f"{major}.{minor}.{patch}"
          config['version'] = new_version
          config_path.write_text(json.dumps(config, indent=2) + '\n', encoding='utf-8')

          before = "${{ steps.detect.outputs.before }}"
          after = "${{ steps.detect.outputs.after }}"
          entry = f"## {new_version}\n### What’s changed\n\n#### ⬆️ Dependency updates\n- Automated upstream update: AliasVault image bumped from `{before}` to `{after}` via Renovate.\n\n### Notes\nThis remains an **unofficial community add-on** for AliasVault.\nFor AliasVault core issues, report upstream:\nhttps://github.com/aliasvault/aliasvault\n\n"
          text = changelog_path.read_text(encoding='utf-8')
          if text.startswith('# Changelog\n\n'):
              text = '# Changelog\n\n' + entry + text[len('# Changelog\n\n'):]
          else:
              text = '# Changelog\n\n' + entry + text

          # Keep Home Assistant changelog compact: only latest 3 version sections.
          # Move older entries to CHANGELOG_ARCHIVE.md.
          header = '# Changelog\n\n'
          body = text[len(header):] if text.startswith(header) else text

          sections = []
          current = []
          for line in body.splitlines():
              if line.startswith('## '):
                  if current:
                      sections.append('\n'.join(current).strip())
                      current = []
              current.append(line)
          if current:
              sections.append('\n'.join(current).strip())

          keep = [s for s in sections[:3] if s]
          overflow = [s for s in sections[3:] if s]

          text = header + '\n\n'.join(keep).strip() + '\n\n' + \
              'Oudere wijzigingen: zie `aliasvault/CHANGELOG_ARCHIVE.md` en GitHub Releases.\n'
          changelog_path.write_text(text, encoding='utf-8')

          if overflow:
              archive_path = Path('aliasvault/CHANGELOG_ARCHIVE.md')
              archive_header = '# Changelog (archief)\n\nHistorische wijzigingen die niet meer in de Home Assistant changelog-weergave hoeven te staan.\n\n'
              existing_archive = archive_path.read_text(encoding='utf-8') if archive_path.exists() else archive_header
              if not existing_archive.startswith('# Changelog (archief)'):
                  existing_archive = archive_header + existing_archive

              archive_body = existing_archive.split('\n\n', 2)[-1] if 'Historische wijzigingen' in existing_archive else existing_archive
              archive_sections = []
              cur = []
              for line in archive_body.splitlines():
                  if line.startswith('## '):
                      if cur:
                          archive_sections.append('\n'.join(cur).strip())
                          cur = []
                  cur.append(line)
              if cur:
                  archive_sections.append('\n'.join(cur).strip())

              merged = []
              seen = set()
              for s in overflow + archive_sections:
                  if s and s not in seen:
                      seen.add(s)
                      merged.append(s)

              archive_text = archive_header + '\n\n'.join(merged).strip() + '\n'
              archive_path.write_text(archive_text, encoding='utf-8')
          PY

      - name: Create pull request with version bump
        if: steps.detect.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          add-paths: |
            aliasvault/config.json
            aliasvault/CHANGELOG.md
            aliasvault/CHANGELOG_ARCHIVE.md
          commit-message: "chore(release): bump add-on version after upstream AliasVault update"
          title: "chore(release): bump add-on version after upstream AliasVault update"
          body: |
            Automated add-on version/changelog bump after upstream AliasVault image update.

            - Upstream image before: `${{ steps.detect.outputs.before }}`
            - Upstream image after: `${{ steps.detect.outputs.after }}`
          branch: "automation/upstream-version-bump"
          delete-branch: true
          labels: dependencies
