name: Auto bump add-on version on upstream image change

on:
  push:
    branches:
      - main
    paths:
      - aliasvault/Dockerfile

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-addon-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Detect upstream image tag change
        id: detect
        run: |
          BEFORE=$(git show HEAD~1:aliasvault/Dockerfile | sed -n 's/^ARG UPSTREAM_IMAGE=ghcr.io\/aliasvault\/aliasvault:\(.*\)$/\1/p' | head -n1)
          AFTER=$(sed -n 's/^ARG UPSTREAM_IMAGE=ghcr.io\/aliasvault\/aliasvault:\(.*\)$/\1/p' aliasvault/Dockerfile | head -n1)
          echo "before=$BEFORE" >> "$GITHUB_OUTPUT"
          echo "after=$AFTER" >> "$GITHUB_OUTPUT"
          if [ -n "$BEFORE" ] && [ -n "$AFTER" ] && [ "$BEFORE" != "$AFTER" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump add-on patch version + changelog
        if: steps.detect.outputs.changed == 'true'
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path

          config_path = Path('aliasvault/config.json')
          changelog_path = Path('aliasvault/CHANGELOG.md')

          config = json.loads(config_path.read_text(encoding='utf-8'))
          old_version = config['version']
          major, minor, patch = map(int, old_version.split('.'))

          # Version policy:
          # - normal upstream auto-bump => patch +1
          # - whenever patch reaches 9, next bump rolls to next minor at .0
          #   examples: 0.0.9 -> 0.1.0, 0.1.9 -> 0.2.0
          if patch >= 9:
              minor += 1
              patch = 0
          else:
              patch += 1

          new_version = f"{major}.{minor}.{patch}"
          config['version'] = new_version
          config_path.write_text(json.dumps(config, indent=2) + '\n', encoding='utf-8')

          before = "${{ steps.detect.outputs.before }}"
          after = "${{ steps.detect.outputs.after }}"
          entry = f"## {new_version}\n- Automated upstream update: AliasVault image bumped from `{before}` to `{after}` via Renovate.\n\n"
          text = changelog_path.read_text(encoding='utf-8')
          if text.startswith('# Changelog\n\n'):
              text = '# Changelog\n\n' + entry + text[len('# Changelog\n\n'):]
          else:
              text = '# Changelog\n\n' + entry + text
          changelog_path.write_text(text, encoding='utf-8')
          PY

      - name: Create pull request with version bump
        if: steps.detect.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore(release): bump add-on version after upstream AliasVault update"
          title: "chore(release): bump add-on version after upstream AliasVault update"
          body: |
            Automated add-on version/changelog bump after upstream AliasVault image update.

            - Upstream image before: `${{ steps.detect.outputs.before }}`
            - Upstream image after: `${{ steps.detect.outputs.after }}`
          branch: "automation/upstream-version-bump"
          delete-branch: true
          labels: dependencies
